name: Generate sitemap.xml

on:
  push:
    branches: ["main"]

permissions:
  contents: write

jobs:
  sitemap:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate sitemap.xml (HTML only, index.html as homepage, exclude link-map)
        run: |
          python3 - << 'PY'
          import os
          from datetime import date

          BASE_URL = "https://pestcontrolbucuresti.github.io/pestcontrol-bucuresti"
          TODAY = date.today().isoformat()

          # fisiere .html din root
          html_files = sorted([
              f for f in os.listdir(".")
              if f.endswith(".html") and os.path.isfile(f)
          ])

          # Excludem pagini care trebuie crawl-uite, dar nu indexate (ex: link map)
          EXCLUDE_FILES = {
              "master-link-map-for-pestcontrol-bucuresti.html",
          }

          html_files = [f for f in html_files if f not in EXCLUDE_FILES]

          urls = []

          # homepage explicit = index.html (evitam dublura cu "/")
          if "index.html" in html_files:
              urls.append(f"{BASE_URL}/index.html")

          for f in html_files:
              if f.lower() == "index.html":
                  continue
              urls.append(f"{BASE_URL}/{f}")

          xml = [
              '<?xml version="1.0" encoding="UTF-8"?>',
              '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">'
          ]

          for u in urls:
              xml.append("  <url>")
              xml.append(f"    <loc>{u}</loc>")
              xml.append(f"    <lastmod>{TODAY}</lastmod>")
              xml.append("  </url>")

          xml.append("</urlset>")

          with open("sitemap.xml", "w", encoding="utf-8") as out:
              out.write("\n".join(xml) + "\n")

          print("Sitemap generated with", len(urls), "URLs")
          PY

      - name: Commit sitemap.xml if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add sitemap.xml
          git diff --cached --quiet && echo "No sitemap changes" || git commit -m "chore: update sitemap.xml"
          git push
